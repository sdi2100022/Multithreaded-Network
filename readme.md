# Κ24 - Systems Programming Prj2
## Multithreaded Network

### Author : Αθανάσιος Γιαβρίδης 

## Σχεδιαστικές Επιλογές
 
### jobCommander.c
- Δέχεται το όνομα του server, τον αριθμό θύρας καθώς και την εντολή που επιθυμεί να τρέξει.
-  Ενώνεται με τον server
-  Στέλνει την εντολή σε αυτόν και περιμένει απάντηση.
-  Δέχεται απάντηση και την εκτυπώνει.
-  Σε περίπτωση εντολής `issueJob` περιμένει και δεύτερο μήνυμα και το εκτυπώνει.
-  Απελευθερώνει την μνήμη και τερματίζει.
### jobExecutorServer.c
- Δέχεται τον αριθμό θύρας καθώς και το bufferSize και threadPoolSize, δηλαδή το μέγεθος του ενταμιευτή και το πλήθος από worker threads.
- Δημιουργεί μια δομή server ονόματι ***network*** που περιέχει τον ενταμιευτή,το μέγεθος του,τον αριθμό παραλληλίας, το πλήθος από ενεργά worker threads και μια σημαία για το όταν ο server θα τερματίζει.
- Δημιουργεί τo mutex και τα global condition variables που θα χρησιμοποιηθούν στα threads.
- Δημιουργεί το server το κάνει bind και έπειτα δημιουργεί τα worker threads.
- Μετά μπαίνει σε έναν ατέρμων βρόχο και περιμένει να του δωθεί ένα request σύνδεσης και ενα το κάνει accept ώστε να δημιουρήσει το controller thread του.
### jobThreads.c
#### **void** ***controller_thread(void** ***arg):** 
-  Το controller thread διαβάζει από την θύρα του πελάτη την εντολή την οποία πρέπει αν τρέξει και έπειτα ανάλογα με την εντολή καλεί την αντίστοιχη συνάρτησή της.
- Οι εντολές είναι οι ακόλουθες:
##### jobCommands.c
1.  **Command `issueJob`**:
    
    -   Δημιουργεί μια νέα εργασία, δημιουργώντας ένα `jobtuple` και το τοποθετεί στην ουρά `jobBuffer` του server.
    -   Eνημερώνει τα worker threads ότι υπάρχει μια νέα εργασία μέσω ενός condition variable.
    -   Επιστρέφει μια συμβολοσειρά που περιέχει τις λεπτομέρειες της νέας εργασίας.
    -   Έπειτα ένα worker thread τρέχει την εργασία και επιστρέφει μια συμβολοσειρά με την έξοδο της.

2.  **Command `setConcurrency`**:
    
    -   Ρυθμίζει την ταυτόχρονη εκτέλεση εργασιών στον server.
    -   Ενημερώνει τα worker threads ότι υπήρχε αλλάγη στην παραλληλία του server.
    -   Επιστρέφει μια συμβολοσειρά που περιέχει ότι η παραλληλία άλλαξε .

3.  **Command `stop`**:
    
    -   Διακόπτει μια εργασία με βάση το `jobID`.
    -   Αναζητά την εργασία στην ουρά `jobBuffer`.
    -   Αν βρεθεί ενημερώνει τα controller threads πως υπάρχει ελεύθερος χώρος στον ενταμιευτή.
    -   Επιστρέφει ένα μήνυμα που δηλώνει αν η εργασία διακόπηκε ή δεν βρέθηκε.

4.  **Command `poll`**:
    
    -   Επιστρέφει μια λίστα με τις εργασίες που βρίσκονται σε κατάσταση αναμονής .
5.  **Command `exit`**:
    
    -   Μεταβάλλει μια σημαία που δηλώνει πως ο server τερματίζει
    -   Απελευθερώνει όλες τις εργασίες σε κατάσταση αναμονής και στέλνει κατάλληλο μήνυμα
    -   Ξυπνάει όλα τα worker threads να τερματίσουν.
    -   Σβήνει το mutex και όλα τα condition variables.
    -   Επιστρέφει ένα μήνυμα τερματισμού του server.
    
  - Έπειτα γράφει το μήνυμα που επέστρεψε η εντολή στην θύρα για να την παραλάβει ο jobCommander
  - Σε περίπτωση που η σημαία **EXIT** έχει γίνει αληθής δεν δέχεται άλλες εντολές και επιστρέφει μήνυμα σφάλματος.
  - Αν η εντολή ηταν `issueJob` κλείνει την θύρα από την πλευρά του server
  - Αν ήρθε εντολή `exit`    απελευθερώνει όλη την δυναμική δέσμευση μνήμης και τερματίζει το πρόγραμμα. 
#### **void** ***worker_thread(void** ***arg):**
 - Τα worker threads είναι σε αναστολή όταν δεν υπάρχει διαθέσιμη εργάσια στον ενταμιευτή ή επειδή τα ενεργά νήματα είναι περισσότερ από τον βαθμό παραλληλίας.
 -  Όταν τρέχει ένα νήμα εργάτη αφαιρεί μια εργασία από την ουρά και την λίστα ορισμάτων της εντολής που πρόκειται να τρέξει.
 - Έπειτα το νήμα σπάει σε δύο με την χρήση **fork**.
 - Το παιδί δημιουργεί ένα αρχείο στο οποίο θα εισαχθεί η έξοδος της εντολής και κάνει ανακατευθύνση της εξόδου σε αυτό το αρχείο.
 - Ο γονιός περιμένει να τερματίσει το παιδί.
 - Εφόσον τερματίσει ανοίγει το αρχείο εξόδου **pid.output** και το μετατρέπει σε μήνυμα που θα μεταφέρει στον πελάτη μέσω της θύρα στην οποία θα γράψει.
 - Έπειτα σβήνει το αρχείο.
 - Το νήμα έχει πια τελειώσει την δουλειά του και ενημερώνει τα κοίνα condition variables.
 - Σε περίπτωση εντολής  `exit` όλα τα νήματα γίνονται ενεργά και απελευθερώνονται με την εντολή **pthread_detach** με το τελευταίο νήμα να ενημερώνει το controller thread πως όλα τα νήματα είναι πια ανενεργά ώστε να τερματίσει ο server.
## Λοιπές Πληροφορίες 
- Tα αρχεία **jobUtil.c/.h** είναι ίδια από την πρώτη εργασία με την μόνη προσθήκη μιας μεταβλητής socket στη δομή jobtuple που κρατάει τη θύρα από την οποία στάλθηκε η εργασία για να επιστρέψει μήνυμα.
- Το κάθε είδος αρχείου βρίσκεται σε ξεχωριστό κατάλογο και κατά την εκτέλεση των εκτελέσιμων προγραμμάτων χρείαζεται ένα prefix **./bin/**.
- Το ξεχωριστό header file **jobProject.h** περιέχει μόνο την δομή server με τις απαραίτητες μεταβλήτες του server όπως τον ενταμιευτή, το μέγιστο δυνατό μέγεθός του και τα λοιπά που αναφέρθηκαν και πιο πάνω.  
## Οδηγίες Χρήσης Εφαρμογής
### makefile
Με την εντολή **make** δημιουργείται τα εκτελέσιμα πρoγραμματά ***./jobCommander , ./jobExecutorServer***.
> make 

Υπάρχει επίσης η εντολή **make scripts** που κάνει εκτελέσιμα τα bash scripts στον κατάλογο /tests/
> make scripts

Επίσης με την εντολή **make clean** διαγράφονται τα εκτελέσιμα καθώς και όλα τα αντικείμενα προγράμματα.
> make clean

Υπάρχει και η εντολή **make count** για το μέτρημα των σειρών,λέξεων και χαρακτήρων σε όλα τα αρχεία
> make count

### Program Call
Αρχικά πρέπει να καλέσουμε το ***./jobExecutorServer*** δίνοντας του τα εξής όρισματα:
> ./jobExecutorServer [portNum] [bufferSize] [threadPoolSize]

Έπειτα καλούμε το πρόγραμμα ***./jobCommander*** όσες φορές θέλουμε με τους εξής τρόπους.

> ./bin/jobCommander [servername] [portNum] issueJob "job"
>
> ./bin/jobCommander  [servername] [portNum] setConcurrency  N
>
> ./bin/jobCommander [servername] [portNum] poll 
>
> ./bin/jobCommander  [servername] [portNum] stop "job_XX"
>
> ./bin/jobCommander [servername] [portNum] exit
>

Μόλις σταλθεί `exit` το ***./jobExecutorServer*** τερματίζει.

### Scripts
Kαλόυμε τα script δίνοντας [servername] [portNum]:
- **/tests/test_jobExecutor_X.sh** : Tα test αρχεία της 1ης εργασίας γραμμένα σε script για να τρέχουν κατευθείαν, η κάθε εντολή ανοίγει νέο terminal.
- **/tests/test_runAll.sh** : Ένα script που τρέχει τα 8 παραπάνω test scripts με την σείρα ανοίγοντας καινούριο server κάθε φορά όμως ο server και οι commander θα τρέχουν στον ίδιο server. 


